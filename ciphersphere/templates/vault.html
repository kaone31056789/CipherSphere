{% extends "base.html" %}

{% block title %}Vault - CipherSphere{% endblock %}

{% block content %}
<div class="cyber-container">
    <div class="vault-header cyber-card">
        <div class="vault-title">
            <h2>
                <i class="fas fa-vault"></i>
                Personal Vault
            </h2>
            <p>Your encrypted files are stored securely here</p>
        </div>
        <div class="vault-stats">
            <div class="stat-item">
                <span class="stat-number">{{ files|length }}</span>
                <span class="stat-label">Files</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ (files|sum(attribute='file_size') / 1024 / 1024) | round(2) }}</span>
                <span class="stat-label">MB</span>
            </div>
        </div>
    </div>

    {% if files %}
    <div class="vault-controls cyber-card">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search files..." id="fileSearch">
        </div>
        <div class="filter-controls">
            <select id="algorithmFilter" class="cyber-select">
                <option value="">All Algorithms</option>
                <option value="AES">AES</option>
                <option value="Fernet">Fernet</option>
                <option value="RSA">RSA</option>
            </select>
            <select id="typeFilter" class="cyber-select">
                <option value="">All Types</option>
                <option value="text">Text Files</option>
                <option value="file">Binary Files</option>
            </select>
        </div>
    </div>

    <div class="vault-grid">
        {% for file in files %}
        <div class="file-card cyber-card" 
             data-algorithm="{{ file.algorithm }}" 
             data-type="{{ 'text' if file.is_text else 'file' }}"
             data-name="{{ file.original_filename.lower() }}">
            
            <div class="file-header">
                <div class="file-icon">
                    {% if file.is_text %}
                        <i class="fas fa-file-alt"></i>
                    {% else %}
                        {% set ext = file.original_filename.split('.')[-1].lower() %}
                        {% if ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                            <i class="fas fa-file-image"></i>
                        {% elif ext in ['pdf'] %}
                            <i class="fas fa-file-pdf"></i>
                        {% elif ext in ['doc', 'docx'] %}
                            <i class="fas fa-file-word"></i>
                        {% elif ext in ['zip', 'rar'] %}
                            <i class="fas fa-file-archive"></i>
                        {% else %}
                            <i class="fas fa-file"></i>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="file-actions">
                    <button class="action-btn" title="Download" onclick="downloadFile({{ file.id }})">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn" title="Change Security Key" onclick="changeSecurityKey({{ file.id }}, '{{ file.original_filename }}', '{{ file.algorithm }}')">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="action-btn" title="Share" onclick="shareFile({{ file.id }})">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="action-btn delete" title="Delete" onclick="deleteFile({{ file.id }})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="file-content">
                <h3 class="file-name">{{ file.original_filename }}</h3>
                <div class="file-details">
                    <span class="file-algorithm {{ file.algorithm.lower() }}">
                        <i class="fas fa-key"></i>
                        {{ file.algorithm }}
                    </span>
                    <span class="file-size">
                        <i class="fas fa-hdd"></i>
                        {{ (file.file_size / 1024) | round(2) }} KB
                    </span>
                    <span class="file-date">
                        <i class="fas fa-calendar"></i>
                        {{ file.created_at.strftime('%b %d, %Y') }}
                    </span>
                </div>
            </div>

            <div class="file-footer">
                <div class="file-type">
                    {{ 'Text Content' if file.is_text else 'Binary File' }}
                </div>
                {% if file.is_favorite %}
                <div class="favorite-badge">
                    <i class="fas fa-star"></i>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-vault cyber-card">
        <div class="empty-content">
            <i class="fas fa-vault"></i>
            <h3>Your vault is empty</h3>
            <p>Start by encrypting some files to see them here</p>
            <a href="{{ url_for('encrypt') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-lock"></i>
                Encrypt Files
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Share File Modal -->
<div class="modal" id="shareModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Share File</h3>
            <button class="modal-close" onclick="closeShareModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="shareForm">
                <div class="cyber-form-group">
                    <label class="cyber-label">Recipient Username</label>
                    <input type="text" class="cyber-input" id="recipientUsername" placeholder="Enter username">
                </div>
                <div class="cyber-form-group">
                    <label class="cyber-label">Permissions</label>
                    <select class="cyber-select" id="permissions">
                        <option value="read">Read Only</option>
                        <option value="download">Read & Download</option>
                        <option value="edit">Full Access</option>
                    </select>
                </div>
                <div class="cyber-form-group">
                    <label class="cyber-label">Message (Optional)</label>
                    <textarea class="cyber-textarea" id="shareMessage" placeholder="Add a message for the recipient"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeShareModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmShare()">Share File</button>
        </div>
    </div>
</div>

<!-- Change Security Key Modal -->
<div class="modal" id="changeKeyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Security Key</h3>
            <button class="modal-close" onclick="closeChangeKeyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="key-change-info">
                <div class="info-section">
                    <i class="fas fa-info-circle text-cyan-400"></i>
                    <div>
                        <h4>Important Information</h4>
                        <p>Changing the security key will re-encrypt your file with a new key. This operation cannot be undone.</p>
                    </div>
                </div>
            </div>
            
            <form id="changeKeyForm">
                <input type="hidden" id="changeKeyFileId">
                
                <div class="cyber-form-group">
                    <label class="cyber-label">Current Security Key</label>
                    <div class="key-input-group">
                        <input type="password" class="cyber-input" id="currentKey" placeholder="Enter current encryption key" required>
                        <button type="button" class="key-toggle-btn" onclick="toggleKeyVisibility('currentKey', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="cyber-form-group">
                    <label class="cyber-label">New Security Key</label>
                    <div class="key-input-group">
                        <input type="password" class="cyber-input" id="newKey" placeholder="Enter new encryption key">
                        <button type="button" class="key-toggle-btn" onclick="toggleKeyVisibility('newKey', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="key-generate-btn" onclick="generateNewKey()">
                            <i class="fas fa-random"></i>
                        </button>
                    </div>
                    <small class="help-text">Leave blank to auto-generate a secure key</small>
                </div>

                <div class="cyber-form-group">
                    <label class="cyber-label">Confirm New Key</label>
                    <div class="key-input-group">
                        <input type="password" class="cyber-input" id="confirmNewKey" placeholder="Confirm new encryption key">
                        <button type="button" class="key-toggle-btn" onclick="toggleKeyVisibility('confirmNewKey', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <!-- Key Strength Indicator -->
                <div class="key-strength-indicator">
                    <label class="cyber-label">Key Strength</label>
                    <div class="strength-meter">
                        <div class="strength-bar" id="keyStrengthBar"></div>
                    </div>
                    <span class="strength-text" id="keyStrengthText">Enter a key to check strength</span>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeChangeKeyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmChangeKey()">
                <i class="fas fa-key mr-2"></i>Change Key
            </button>
        </div>
    </div>
</div>

<style>
/* Vault Page Styles */
.vault-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2xl);
    margin-bottom: var(--space-xl);
}

.vault-title h2 {
    color: var(--text-primary);
    font-size: var(--text-2xl);
    font-weight: 700;
    margin-bottom: var(--space-xs);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.vault-title p {
    color: var(--text-tertiary);
    font-size: var(--text-base);
}

.vault-stats {
    display: flex;
    gap: var(--space-xl);
}

.stat-item {
    text-align: center;
}

.stat-number {
    display: block;
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--cyber-blue);
}

.stat-label {
    color: var(--text-tertiary);
    font-size: var(--text-sm);
}

.vault-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-lg) var(--space-2xl);
    margin-bottom: var(--space-xl);
}

.search-bar {
    position: relative;
    flex: 1;
    max-width: 400px;
}

.search-bar i {
    position: absolute;
    left: var(--space-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-tertiary);
}

.search-bar input {
    width: 100%;
    padding: var(--space-md) var(--space-md) var(--space-md) 2.5rem;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: var(--text-base);
}

.filter-controls {
    display: flex;
    gap: var(--space-md);
}

.vault-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-xl);
}

.file-card {
    padding: 0;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-lg) var(--space-xl);
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid var(--border-subtle);
}

.file-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background: rgba(0, 212, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--cyber-blue);
    font-size: var(--text-xl);
}

.file-actions {
    display: flex;
    gap: var(--space-sm);
}

.action-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 1px solid var(--border-subtle);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.action-btn.delete {
    color: var(--tesla-red);
}

.action-btn.delete:hover {
    background: rgba(227, 24, 55, 0.1);
}

.file-content {
    padding: var(--space-xl);
}

.file-name {
    color: var(--text-primary);
    font-size: var(--text-lg);
    font-weight: 600;
    margin-bottom: var(--space-md);
    word-break: break-word;
}

.file-details {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.file-details span {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    color: var(--text-tertiary);
    font-size: var(--text-sm);
}

.file-algorithm {
    padding: var(--space-xs) var(--space-sm);
    border-radius: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.file-algorithm.aes {
    background: rgba(0, 212, 255, 0.1);
    color: var(--cyber-blue);
}

.file-algorithm.fernet {
    background: rgba(0, 255, 136, 0.1);
    color: var(--success);
}

.file-algorithm.rsa {
    background: rgba(255, 170, 0, 0.1);
    color: var(--warning);
}

.file-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-lg) var(--space-xl);
    background: rgba(255, 255, 255, 0.03);
    border-top: 1px solid var(--border-subtle);
}

.file-type {
    color: var(--text-tertiary);
    font-size: var(--text-xs);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.favorite-badge {
    color: var(--warning);
}

.empty-vault {
    text-align: center;
    padding: var(--space-4xl);
}

.empty-content i {
    font-size: 4rem;
    color: var(--text-tertiary);
    margin-bottom: var(--space-xl);
}

.empty-content h3 {
    color: var(--text-primary);
    font-size: var(--text-xl);
    margin-bottom: var(--space-md);
}

.empty-content p {
    color: var(--text-tertiary);
    margin-bottom: var(--space-xl);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    backdrop-filter: blur(10px);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-card);
    border-radius: 16px;
    border: 1px solid var(--border-subtle);
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xl);
    border-bottom: 1px solid var(--border-subtle);
}

.modal-header h3 {
    color: var(--text-primary);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-tertiary);
    font-size: var(--text-xl);
    cursor: pointer;
}

.modal-body {
    padding: var(--space-xl);
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-md);
    padding: var(--space-xl);
    border-top: 1px solid var(--border-subtle);
}

@media (max-width: 768px) {
    .vault-header {
        flex-direction: column;
        text-align: center;
        gap: var(--space-lg);
    }
    
    .vault-controls {
        flex-direction: column;
        gap: var(--space-lg);
    }
    
    .filter-controls {
        width: 100%;
        justify-content: center;
    }
    
    .vault-grid {
        grid-template-columns: 1fr;
    }
}

/* Change Security Key Modal Styles */
.key-change-info {
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
}

.info-section {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.info-section i {
    font-size: 20px;
    margin-top: 2px;
}

.info-section h4 {
    color: var(--text-primary);
    margin: 0 0 4px 0;
    font-size: 16px;
}

.info-section p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 14px;
    line-height: 1.5;
}

.key-input-group {
    position: relative;
    display: flex;
    align-items: center;
}

.key-input-group .cyber-input {
    flex: 1;
    padding-right: 80px;
}

.key-toggle-btn, .key-generate-btn {
    position: absolute;
    right: 8px;
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.key-generate-btn {
    right: 40px;
}

.key-toggle-btn:hover, .key-generate-btn:hover {
    color: var(--tesla-cyan);
    background: rgba(0, 255, 255, 0.1);
}

.help-text {
    color: var(--text-tertiary);
    font-size: 12px;
    margin-top: 4px;
    display: block;
}

.key-strength-indicator {
    margin-top: 16px;
}

.strength-meter {
    height: 4px;
    background: var(--bg-secondary);
    border-radius: 2px;
    overflow: hidden;
    margin: 8px 0;
}

.strength-bar {
    height: 100%;
    border-radius: 2px;
    transition: all 0.3s ease;
    width: 0%;
    background: var(--tesla-red);
}

.strength-bar.weak {
    width: 25%;
    background: var(--tesla-red);
}

.strength-bar.fair {
    width: 50%;
    background: var(--tesla-orange);
}

.strength-bar.good {
    width: 75%;
    background: var(--tesla-blue);
}

.strength-bar.strong {
    width: 100%;
    background: var(--tesla-green);
}

.strength-text {
    font-size: 12px;
    color: var(--text-tertiary);
}

.strength-text.weak { color: var(--tesla-red); }
.strength-text.fair { color: var(--tesla-orange); }
.strength-text.good { color: var(--tesla-blue); }
.strength-text.strong { color: var(--tesla-green); }
</style>

<script>
let currentFileId = null;

// Search functionality
document.getElementById('fileSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    filterFiles();
});

// Filter functionality
document.getElementById('algorithmFilter').addEventListener('change', filterFiles);
document.getElementById('typeFilter').addEventListener('change', filterFiles);

function filterFiles() {
    const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
    const algorithmFilter = document.getElementById('algorithmFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    document.querySelectorAll('.file-card').forEach(card => {
        const name = card.getAttribute('data-name');
        const algorithm = card.getAttribute('data-algorithm');
        const type = card.getAttribute('data-type');
        
        const matchesSearch = name.includes(searchTerm);
        const matchesAlgorithm = !algorithmFilter || algorithm === algorithmFilter;
        const matchesType = !typeFilter || type === typeFilter;
        
        if (matchesSearch && matchesAlgorithm && matchesType) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function downloadFile(fileId) {
    // Show loading state
    const downloadBtn = document.querySelector(`button[onclick="downloadFile(${fileId})"]`);
    const originalContent = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    downloadBtn.disabled = true;
    
    // Attempt download
    fetch(`/vault/download/${fileId}`, {
        method: 'GET',
        headers: {
            'Accept': 'application/octet-stream'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Get filename from response headers
        const contentDisposition = response.headers.get('content-disposition');
        let filename = 'download';
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
            if (filenameMatch) {
                filename = filenameMatch[1];
            }
        }
        
        return response.blob().then(blob => ({ blob, filename }));
    })
    .then(({ blob, filename }) => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Show success message
        showNotification('File downloaded successfully!', 'success');
    })
    .catch(error => {
        console.error('Download error:', error);
        
        // Fallback to direct window location
        try {
            window.location.href = `/vault/download/${fileId}`;
        } catch (fallbackError) {
            console.error('Fallback download failed:', fallbackError);
            showNotification('Download failed. Please try again or contact support.', 'error');
        }
    })
    .finally(() => {
        // Restore button state
        downloadBtn.innerHTML = originalContent;
        downloadBtn.disabled = false;
    });
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Add styles
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: ${type === 'success' ? 'linear-gradient(135deg, rgba(0, 255, 127, 0.9), rgba(0, 200, 100, 0.9))' : 
                   type === 'error' ? 'linear-gradient(135deg, rgba(255, 51, 102, 0.9), rgba(200, 0, 50, 0.9))' : 
                   'linear-gradient(135deg, rgba(0, 212, 255, 0.9), rgba(0, 150, 200, 0.9))'};
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 400px;
        word-wrap: break-word;
    `;
    
    notification.querySelector('.notification-content').style.cssText = `
        display: flex;
        align-items: center;
        gap: 12px;
    `;
    
    notification.querySelector('.notification-close').style.cssText = `
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}

function shareFile(fileId) {
    currentFileId = fileId;
    document.getElementById('shareModal').style.display = 'block';
}

function deleteFile(fileId) {
    if (confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
        fetch(`/vault/delete/${fileId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the file.');
        });
    }
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
    currentFileId = null;
}

function confirmShare() {
    const recipient = document.getElementById('recipientUsername').value;
    const permissions = document.getElementById('permissions').value;
    const message = document.getElementById('shareMessage').value;
    
    if (!recipient) {
        alert('Please enter a recipient username');
        return;
    }
    
    fetch(`/vault/share/${currentFileId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            recipient: recipient,
            permissions: permissions,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('File shared successfully!');
            closeShareModal();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sharing the file.');
    });
}

// Close modal when clicking outside
document.getElementById('shareModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeShareModal();
    }
});

// Change Security Key Functions
function changeSecurityKey(fileId, filename, algorithm) {
    currentFileId = fileId;
    document.getElementById('changeKeyFileId').value = fileId;
    document.getElementById('changeKeyModal').style.display = 'flex';
    
    // Clear previous inputs
    document.getElementById('currentKey').value = '';
    document.getElementById('newKey').value = '';
    document.getElementById('confirmNewKey').value = '';
    updateKeyStrength('');
}

function closeChangeKeyModal() {
    document.getElementById('changeKeyModal').style.display = 'none';
    currentFileId = null;
}

function toggleKeyVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function generateNewKey() {
    // Generate a secure random key
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let key = '';
    for (let i = 0; i < 32; i++) {
        key += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    
    const newKeyInput = document.getElementById('newKey');
    const confirmKeyInput = document.getElementById('confirmNewKey');
    
    newKeyInput.value = key;
    confirmKeyInput.value = key;
    
    // Show the generated key temporarily
    newKeyInput.type = 'text';
    confirmKeyInput.type = 'text';
    
    updateKeyStrength(key);
    
    // Hide after 3 seconds
    setTimeout(() => {
        if (newKeyInput.type === 'text') {
            newKeyInput.type = 'password';
            confirmKeyInput.type = 'password';
            // Update button icons
            const newKeyBtn = newKeyInput.parentElement.querySelector('.key-toggle-btn i');
            const confirmKeyBtn = confirmKeyInput.parentElement.querySelector('.key-toggle-btn i');
            newKeyBtn.classList.remove('fa-eye-slash');
            newKeyBtn.classList.add('fa-eye');
            confirmKeyBtn.classList.remove('fa-eye-slash');
            confirmKeyBtn.classList.add('fa-eye');
        }
    }, 3000);
}

function updateKeyStrength(key) {
    const strengthBar = document.getElementById('keyStrengthBar');
    const strengthText = document.getElementById('keyStrengthText');
    
    if (!key) {
        strengthBar.className = 'strength-bar';
        strengthText.textContent = 'Enter a key to check strength';
        strengthText.className = 'strength-text';
        return;
    }
    
    let score = 0;
    
    // Length check
    if (key.length >= 8) score++;
    if (key.length >= 16) score++;
    
    // Character variety checks
    if (/[a-z]/.test(key)) score++;
    if (/[A-Z]/.test(key)) score++;
    if (/[0-9]/.test(key)) score++;
    if (/[!@#$%^&*(),.?":{}|<>]/.test(key)) score++;
    
    // Determine strength
    let strength, text;
    if (score <= 2) {
        strength = 'weak';
        text = 'Weak - Use a longer, more complex key';
    } else if (score <= 4) {
        strength = 'fair';
        text = 'Fair - Consider adding more variety';
    } else if (score <= 5) {
        strength = 'good';
        text = 'Good - Strong encryption key';
    } else {
        strength = 'strong';
        text = 'Excellent - Very secure key';
    }
    
    strengthBar.className = `strength-bar ${strength}`;
    strengthText.textContent = text;
    strengthText.className = `strength-text ${strength}`;
}

function confirmChangeKey() {
    const currentKey = document.getElementById('currentKey').value;
    const newKey = document.getElementById('newKey').value;
    const confirmNewKey = document.getElementById('confirmNewKey').value;
    const fileId = document.getElementById('changeKeyFileId').value;
    
    // Validation
    if (!currentKey) {
        alert('Please enter the current security key.');
        return;
    }
    
    if (!newKey) {
        alert('Please enter a new security key or generate one.');
        return;
    }
    
    if (newKey !== confirmNewKey) {
        alert('New key and confirmation do not match.');
        return;
    }
    
    if (newKey === currentKey) {
        alert('New key must be different from the current key.');
        return;
    }
    
    // Send request to change key
    fetch(`/vault/change-key/${fileId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            current_key: currentKey,
            new_key: newKey
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Security key changed successfully!');
            closeChangeKeyModal();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while changing the security key.');
    });
}

// Key strength checking on input
document.getElementById('newKey').addEventListener('input', function(e) {
    updateKeyStrength(e.target.value);
});

// Close change key modal when clicking outside
document.getElementById('changeKeyModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeChangeKeyModal();
    }
});
</script>
{% endblock %}
