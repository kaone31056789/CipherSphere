{% extends "base.html" %}

{% block title %}File Management - CipherSphere Admin{% endblock %}

{% block content %}
<div class="admin-layout">
    <!-- Admin Sidebar Hover Trigger -->
    <div class="admin-sidebar-trigger"></div>
    
    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
        <div class="admin-brand">
            <i class="fas fa-shield-alt"></i>
            <span>Admin Panel</span>
        </div>
        
        <nav class="admin-nav">
            <ul>
                <li>
                    <a href="{{ url_for('admin_dashboard') }}" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin_users') }}" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>User Management</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin_files') }}" class="nav-item active">
                        <i class="fas fa-file-lock"></i>
                        <span>File Management</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin_activity') }}" class="nav-item">
                        <i class="fas fa-history"></i>
                        <span>Activity Logs</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin_settings') }}" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span>System Settings</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('dashboard') }}" class="nav-item">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back to Dashboard</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Admin Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-content">
                <h1 class="page-title">File Management</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search files..." id="fileSearch">
                    </div>
                </div>
            </div>
        </header>

        <div class="admin-content">
            <!-- File Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-file-lock"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ total_files }}</h3>
                        <p>Total Files</p>
                        <span class="stat-change positive">{{ (total_size / 1024 / 1024) | round(2) }} MB</span>
                    </div>
                </div>

                {% for algorithm, stats in algorithms.items() %}
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ stats.count }}</h3>
                        <p>{{ algorithm }} Files</p>
                        <span class="stat-change neutral">{{ (stats.size / 1024 / 1024) | round(2) }} MB</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Files Table -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3>All Files ({{ files|length }})</h3>
                    <div class="table-filters">
                        <select class="filter-select">
                            <option>All Files</option>
                            <option>AES Encrypted</option>
                            <option>RSA Encrypted</option>
                            <option>Fernet Encrypted</option>
                            <option>Recent Files</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="select-all">
                                </th>
                                <th>File Name</th>
                                <th>Owner</th>
                                <th>Algorithm</th>
                                <th>Size</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="select-file" data-file-id="{{ file.id }}">
                                </td>
                                <td>
                                    <div class="file-info">
                                        <i class="fas fa-file-lock"></i>
                                        <div class="file-details">
                                            <h4>{{ file.original_filename }}</h4>
                                            <p>{{ file.filename }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="user-info-cell">
                                        <img src="https://via.placeholder.com/40x40/0066ff/ffffff?text={{ file.user.full_name[0] }}" alt="{{ file.user.full_name }}" class="user-avatar-small">
                                        <div class="user-details">
                                            <h4>{{ file.user.full_name }}</h4>
                                            <p>{{ file.user.username }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge {% if file.algorithm == 'AES' %}admin{% elif file.algorithm == 'RSA' %}user{% else %}active{% endif %}">
                                        {{ file.algorithm }}
                                    </span>
                                </td>
                                <td>
                                    {% if file.file_size %}
                                        {{ (file.file_size / 1024) | round(2) }} KB
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                </td>
                                <td>{{ file.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn edit" title="Download File" onclick="downloadFile({{ file.id }})">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="action-btn delete" title="Delete File" onclick="deleteFile({{ file.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button class="action-btn more" title="More Options">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="table-pagination">
                    <div class="pagination-info">
                        Showing 1-{{ files|length }} of {{ files|length }} files
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="pagination-pages">
                            <button class="pagination-page active">1</button>
                        </span>
                        <button class="pagination-btn" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// File management functions
function deleteFile(fileId) {
    if (confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
        fetch(`/admin/files/${fileId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the file.');
        });
    }
}

function downloadFile(fileId) {
    window.location.href = `/download/${fileId}`;
}

// File search functionality
document.getElementById('fileSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.admin-table tbody tr');
    
    rows.forEach(row => {
        const fileName = row.querySelector('.file-details h4').textContent.toLowerCase();
        const ownerName = row.querySelector('.user-details h4').textContent.toLowerCase();
        
        if (fileName.includes(searchTerm) || ownerName.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
